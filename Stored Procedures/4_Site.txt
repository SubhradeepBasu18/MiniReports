create proc sp_GetAllSiteNames
as
begin
	select SiteName from dbo.Site
end;

exec sp_GetAllSiteNames;



create proc sp_GetSiteDetailsByID
 @SiteID int
as
begin
	select site.SiteName, entity.TypeName, site.Address  from dbo.Site site 
	join EntityType entity
	on site.SiteTypeID = entity.EntityTypeID
	where site.SiteID = @SiteID
end;

exec sp_GetSiteDetailsByID @SiteID = 1;

ALTER proc [dbo].[sp_InsertSite]
	@SiteName varchar(200),
	@SiteTypeID int,
	@Address varchar(300),
	@GrantID int
as
begin
	insert into Site (SiteName, SiteTypeID, Address, GranteeID)
	values(@SiteName, @SiteTypeID, @Address, @GrantID)
end;


create proc sp_GetAllSitesByGranteeID
	@GranteeID INT
as
begin
	select SiteName from dbo.Site
	where GranteeID = @GranteeID
end;

exec sp_GetAllSitesByGranteeID @GranteeID = 4;

CREATE OR ALTER PROCEDURE dbo.sp_GetSiteByID
    @SiteID INT
AS
BEGIN
    SELECT
        SiteID      = s.SiteID,
        SiteName    = s.SiteName,
        SiteTypeID  = s.SiteTypeID,
        Address     = s.Address,
        GrantID     = s.GranteeID
    FROM dbo.Site s
    WHERE s.SiteID = @SiteID;
END
GO

exec dbo.sp_GetSiteByID @SiteID = 1;


create or alter proc sp_DeleteSiteByID
	@SiteID int
as
begin
	set nocount on
	begin try
		begin transaction
			
			delete sg from dbo.SchoolGrade sg
			join dbo.School school
			on sg.SchoolID = school.SchoolID
			where school.SiteID = @SiteID;

			delete from dbo.School
			where SiteID = @SiteID;

			delete from dbo.Site
			where SiteID = @SiteID;

		commit transaction;
	end try
	begin catch
		if @@TRANCOUNT>0
		rollback transaction;
	end catch;

end;

exec sp_DeleteSiteByID @SiteID = 6;