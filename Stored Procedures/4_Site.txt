create proc sp_GetAllSiteNames
as
begin
	select SiteName from dbo.Site
end;

exec sp_GetAllSiteNames;



create proc sp_GetSiteDetailsByID
 @SiteID int
as
begin
	select site.SiteName, entity.TypeName, site.Address  from dbo.Site site 
	join EntityType entity
	on site.SiteTypeID = entity.EntityTypeID
	where site.SiteID = @SiteID
end;

exec sp_GetSiteDetailsByID @SiteID = 1;

ALTER   PROCEDURE [dbo].[sp_InsertOrEditSite]
(
    @SiteID INT = 0,
    @SiteName VARCHAR(200),
    @SiteTypeID INT,
    @Address VARCHAR(300),
    @GrantID INT
)
AS
BEGIN
    SET NOCOUNT ON;

    IF @SiteID = 0
    BEGIN
        INSERT INTO dbo.Site (SiteName, SiteTypeID, Address, GranteeID)
        VALUES (@SiteName, @SiteTypeID, @Address, @GrantID);

        -- return new identity
        SELECT CAST(SCOPE_IDENTITY() AS INT) AS SiteID;
    END
    ELSE
    BEGIN
        UPDATE dbo.Site
        SET
            SiteName = @SiteName,
            SiteTypeID = @SiteTypeID,
            Address = @Address
        WHERE SiteID = @SiteID;

        SELECT @SiteID AS SiteID;
    END
END




create proc sp_GetAllSitesByGranteeID
	@GranteeID INT
as
begin
	select SiteName from dbo.Site
	where GranteeID = @GranteeID
end;

exec sp_GetAllSitesByGranteeID @GranteeID = 4;

CREATE OR ALTER PROCEDURE dbo.sp_GetSiteByID
    @SiteID INT
AS
BEGIN
    SELECT
        SiteID      = s.SiteID,
        SiteName    = s.SiteName,
        SiteTypeID  = s.SiteTypeID,
        Address     = s.Address,
        GrantID     = s.GranteeID
    FROM dbo.Site s
    WHERE s.SiteID = @SiteID;
END
GO

exec dbo.sp_GetSiteByID @SiteID = 1;


create or alter proc sp_DeleteSiteByID
	@SiteID int
as
begin
	-- set nocount on
	begin try
		begin transaction
			
			delete sg from dbo.SchoolGrade sg
			join dbo.School school
			on sg.SchoolID = school.SchoolID
			where school.SiteID = @SiteID;

			delete from dbo.School
			where SiteID = @SiteID;

			delete from dbo.Site
			where SiteID = @SiteID;

		commit transaction;
	end try
	begin catch
		if @@TRANCOUNT>0
		rollback transaction;
	end catch;

end;

exec sp_DeleteSiteByID @SiteID = 6;